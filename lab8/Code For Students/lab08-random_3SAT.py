from random import choice
from time import time
from tools import list_minisat2list_our_sat
from pysat.solvers import Solver


def eval_clause(clause, assignment):
    for i in range(len(clause)):
        if clause[i] < 0 and assignment[abs(clause[i])] == 0:
            return True
        if clause[i] > 0 and assignment[abs(clause[i])] == 1:
            return True
    return False

def eval_3CNF(assignment, clauses):
    for i in range(len(clauses)):
        if not eval_clause(clauses[i], assignment):
            return i, False
    return None, True

def random_3SAT(num_variables, clauses):
    assignment = [None] + [choice([0, 1]) for b in range(num_variables)]
    # TODO
    for i in range(1, len(assignment) + 1):
        clause_to_change, satisfied = eval_3CNF(assignment, clauses)
        if not satisfied:
            num_to_change = abs(choice(clauses[clause_to_change]))
            assignment[num_to_change] = 1 if assignment[num_to_change] == 0 else 0
            continue
        return assignment
    return "UNSATISFIABLE"


def solve_SAT(num_variables, clauses):
    for i in range(10 * num_variables):
        resultado = random_3SAT(num_variables, clauses)
        if resultado != "UNSATISFIABLE":
            return resultado
    return "UNSATISFIABLE"


def test1():
    clauses = [[1, 2], [1, -2]]
    solutions = [[0, 1, 0],
                 [0, 1, 1],
                 [0, 1, None],
                 [1, 1, 0],
                 [1, 1, 1],
                 [1, 1, None],
                 [None, 1, 0],
                 [None, 1, 1],
                 [None, 1, None]]
    assert solve_SAT(2, clauses) in solutions

    clauses = [[1, -2, -3], [2, -3, 1], [3, -2, 1],
               [2, 3, 1]]
    solutions = [[0, 1, 0, 0],
                 [0, 1, 0, 1],
                 [0, 1, 1, 0],
                 [0, 1, 1, 1],
                 [1, 1, 0, 0],
                 [1, 1, 0, 1],
                 [1, 1, 1, 0],
                 [1, 1, 1, 1],
                 [None, 1, 0, 0],
                 [None, 1, 0, 1],
                 [None, 1, 1, 0],
                 [None, 1, 1, 1],
                 [None, 1, None, None]]
    assert solve_SAT(3, clauses) in solutions

    clauses = [[2, 1, 3], [-2, -1, 3], [-2, 3, -1], [-2, -1, 3],
               [2, 3, 1], [-1, 3, -2], [-3, 2, 1], [1, -3, -2],
               [-2, -1, 3], [1, -2, -3], [-2, -1, 3], [-1, -2, -3],
               [3, -2, 1], [2, 1, 3], [-3, -1, 2], [-3, -2, 1],
               [-1, 3, -2], [1, 2, -3], [-3, -1, 2], [2, -1, 3]]
    assert solve_SAT(3, clauses) == "UNSATISFIABLE"

    clauses = [[4, -18, 19], [3, 18, -5], [-5, -8, -15], [-20, 7, -16], [10, -13, -7],
               [-12, -9, 17], [17, 19, 5], [-16, 9, 15], [11, -5, -14], [18, -10, 13],
               [-3, 11, 12], [-6, -17, -8], [-18, 14, 1], [-19, -15, 10], [12, 18, -19],
               [-8, 4, 7], [-8, -9, 4], [7, 17, -15], [12, -7, -14], [-10, -11, 8],
               [2, -15, -11], [9, 6, 1], [-11, 20, -17], [9, -15, 13], [12, -7, -17],
               [-18, -2, 20], [20, 12, 4], [19, 11, 14], [-16, 18, -4], [-1, -17, -19],
               [-13, 15, 10], [-12, -14, -13], [12, -14, -7], [-7, 16, 10], [6, 10, 7],
               [20, 14, -16], [-19, 17, 11], [-7, 1, -20], [-5, 12, 15], [-4, -9, -13],
               [12, -11, -7], [-5, 19, -8], [-16], [20, -14, -15], [13, -4, 10],
               [14, 7, 10], [-5, 9, 20], [10, 1, -19], [-16, -15, -1], [16, 3, -11],
               [-15, -10, 4], [4, -15, -3], [-10, -16, 11], [-8, 12, -5], [14, -6, 12],
               [1, 6, 11], [-13, -5, -1], [-12], [1, -20, 19], [-2, -13, -8],
               [18], [-11, 14, 9], [-6, -15, -2], [-5], [-6, 17, 5],
               [-13, 5, -19], [20, -1, 14], [9, -17, 15], [-5, 19, -18], [-12, 8, -10],
               [-18, 14, -4], [15, -9, 13], [9, -5, -1], [10, -19, -14], [20, 9, 4],
               [-9, -2, 19], [-5, 13, -17], [2, -10, -18], [-18, 3, 11], [7, -9, 17],
               [-15, -6, -3], [-2, 3, -13], [12, 3, -2], [2, -2, -3, 17], [20, -15, -16],
               [-5, -17, -19], [-20, -18, 11], [-9, 1, -5], [-19, 9, 17], [17], [1],
               [4, -16, -5]]
    assert solve_SAT(20, clauses) == "UNSATISFIABLE"

    clauses = [[15, 4, -3], [-14, -15, 5], [-19, -16, 17], [7, 18, -5], [-14, -16, 12], [-16, -9, 18],
               [9, 16, 4], [-10, 18, 5], [-11, 4, 2], [-6, -12, -16], [12, 3, 5], [-1, -12, -18],
               [8, -15, 11], [-1, 5, 13], [-10, -4, -15], [-17, 1, -15], [3, 12, 17], [17, 2, 19],
               [7, 1, -17], [9, 15, -19], [-8, 2, -16], [7, -2, 17], [-3, 11, -6], [-11, 10, -3],
               [15, -13, -3], [5, -16, -9], [8, 15, 11], [12, 14, -18], [12, -8, 19], [-15, 4, -8],
               [8, 9, -1], [-17, -12, -18], [-2, -3, 8], [-3, 4, -1], [15, 2, 19], [-3, -8, -6],
               [12, 17, 2], [-11, 12, 1], [12, -9, -8], [-7, -14, 2], [10, 14, -11], [-2, 17, 14],
               [-17, 15, 1], [19, 2, 7], [18, -16, -7], [-7, -1, 13], [1, 19, -7], [18, 2, -3],
               [15, -3, 1], [10, 14, -12], [15, -3, -2], [1, -18, -2], [18, -3, -13], [2, 16, 6],
               [10, -5, -15], [-13, -1, -16], [-4, -6, -11], [-15, 4, 1], [-12, -16, 5], [-10, 4, -2],
               [-10, 1, 6], [-3, 13, -19], [5, -8, -11], [11, 6, -12], [7, 15, -8], [6, 1, -5],
               [-7, 1, -19], [18, -4, -7], [6, 16, 5], [-8, 19, 2], [13, 4, 11], [-10, -13, -19],
               [1, 19, 12], [-5, 17, 14], [-5, 1, -7], [-6, 13, -11], [18, -10, -12], [-7, -8, 12],
               [2, -5, 8], [-14, -15, 16], [13, -6, -7], [15, 14, -1], [14, -2, 3], [18, 15, 5],
               [3, -8, -19], [-3, -11, -6], [10, 12, -17], [2, -12, 1], [-8, -9, -19], [-11, 17, 5],
               [-18, -3, 8], [-17, -8, -12]]

    assert solve_SAT(19, clauses) != "UNSATISFIABLE"

    clauses = [[-15, -4, 14], [-7, -4, 13], [-2, 18, 11], [-12, -11, -6], [7, 17, 4], [4, 6, 13], [-15, -9, -14],
               [14, -4, 8],
               [12, -5, -8], [6, -5, -2], [8, -9, 10], [-15, -11, -12], [12, 16, 17], [17, -9, -12], [-12, -4, 11],
               [-18, 17, -9], [-10, -12, -11], [-7, 15, 2], [2, 15, 17], [-15, -7, 10], [1, -15, 11], [-13, -1, -6],
               [-7, -11, 2], [-5, 1, 15], [-14, -13, 18], [14, 12, -1], [18, -16, 9], [5, -11, -13], [-6, 10, -16],
               [-2, 1, 4], [-4, -11, 8], [-8, 18, 1], [-2, 15, -13], [-15, -12, -10], [-18, -14, -6], [1, -17, 10],
               [10, -13, 2], [2, 17, -3], [14, 1, -17], [-16, -2, -11], [16, 7, 15], [-10, -6, 16], [4, -5, 10],
               [8, 10, -12], [1, -9, -14], [18, -9, 11], [16, 7, 12], [-5, -14, -13], [1, 18, 5], [11, 16, 5],
               [-8, 12, -2], [-6, -2, -13], [18, 16, 7], [-3, 9, -13], [-1, 3, 12], [-10, 7, 3], [-15, -6, -1],
               [-1, -7, -3], [1, 5, 13], [7, 6, -9], [1, -4, 3], [6, 8, 1], [12, 14, -8], [12, 5, -13], [-12, 15, 9],
               [-17, -8, 3], [17, -6, 8], [-3, -14, 4]]

    assert solve_SAT(19, clauses) != "UNSATISFIABLE"

    print("First test passed")
    print("____________________________")


def test2():
    tupla = list_minisat2list_our_sat('instancias/1-unsat.cnf')
    assert (solve_SAT(tupla[0], tupla[1])) == "UNSATISFIABLE"

    tupla = list_minisat2list_our_sat('instancias/3-sat.cnf')
    assert (solve_SAT(tupla[0], tupla[1])) != "UNSATISFIABLE"

    tupla = list_minisat2list_our_sat('instancias/4-sat.cnf')
    assert (solve_SAT(tupla[0], tupla[1])) != "UNSATISFIABLE"

    tupla = list_minisat2list_our_sat('instancias/6-unsat.cnf')
    assert (solve_SAT(tupla[0], tupla[1])) == "UNSATISFIABLE"

    tupla = list_minisat2list_our_sat('instancias/7-unsat.cnf')
    assert (solve_SAT(tupla[0], tupla[1])) == "UNSATISFIABLE"

    print("Second test passed")
    print("____________________________")


def test4():
    print("\n" + "Mira la diferencia de tiempos con esta CNF")
    start_time = time()
    llamada_a_pysat = Solver(bootstrap_with=[[39, 40, 1], [-39, -40, 1], [39, -40, -1], [-39, 40, -1],
                                             [1, 41, 2], [-1, -41, 2], [1, -41, -2], [-1, 41, -2],
                                             [2, 42, 3], [-2, -42, 3], [2, -42, -3], [-2, 42, -3],
                                             [3, 43, 4], [-3, -43, 4], [3, -43, -4], [-3, 43, -4],
                                             [4, 44, 5], [-4, -44, 5], [4, -44, -5], [-4, 44, -5],
                                             [5, 45, 6], [-5, -45, 6], [5, -45, -6], [-5, 45, -6],
                                             [6, 46, 7], [-6, -46, 7], [6, -46, -7], [-6, 46, -7],
                                             [7, 47, 8], [-7, -47, 8], [7, -47, -8], [-7, 47, -8],
                                             [8, 48, 9], [-8, -48, 9], [8, -48, -9], [-8, 48, -9],
                                             [9, 49, 10], [-9, -49, 10], [9, -49, -10], [-9, 49, -10],
                                             [10, 50, 11], [-10, -50, 11], [10, -50, -11],
                                             [-10, 50, -11], [11, 51, 12], [-11, -51, 12],
                                             [11, -51, -12], [-11, 51, -12], [12, 52, 13],
                                             [-12, -52, 13], [12, -52, -13], [-12, 52, -13],
                                             [13, 53, 14], [-13, -53, 14], [13, -53, -14],
                                             [-13, 53, -14], [14, 54, 15], [-14, -54, 15],
                                             [14, -54, -15], [-14, 54, -15], [15, 55, 16],
                                             [-15, -55, 16], [15, -55, -16], [-15, 55, -16],
                                             [16, 56, 17], [-16, -56, 17], [16, -56, -17],
                                             [-16, 56, -17], [17, 57, 18], [-17, -57, 18],
                                             [17, -57, -18], [-17, 57, -18], [18, 58, 19],
                                             [-18, -58, 19], [18, -58, -19], [-18, 58, -19],
                                             [19, 59, 60], [-19, -59, 60], [19, -59, -60],
                                             [-19, 59, -60], [20, 59, 60], [-20, -59, 60],
                                             [20, -59, -60], [-20, 59, -60], [21, 58, 20],
                                             [-21, -58, 20], [21, -58, -20], [-21, 58, -20],
                                             [22, 57, 21], [-22, -57, 21], [22, -57, -21],
                                             [-22, 57, -21], [23, 56, 22], [-23, -56, 22],
                                             [23, -56, -22], [-23, 56, -22], [24, 55, 23],
                                             [-24, -55, 23], [24, -55, -23], [-24, 55, -23],
                                             [25, 54, 24], [-25, -54, 24], [25, -54, -24],
                                             [-25, 54, -24], [26, 53, 25], [-26, -53, 25],
                                             [26, -53, -25], [-26, 53, -25], [27, 52, 26],
                                             [-27, -52, 26], [27, -52, -26], [-27, 52, -26],
                                             [28, 51, 27], [-28, -51, 27], [28, -51, -27],
                                             [-28, 51, -27], [29, 50, 28], [-29, -50, 28],
                                             [29, -50, -28], [-29, 50, -28], [30, 49, 29],
                                             [-30, -49, 29], [30, -49, -29], [-30, 49, -29],
                                             [31, 48, 30], [-31, -48, 30], [31, -48, -30],
                                             [-31, 48, -30], [32, 47, 31], [-32, -47, 31],
                                             [32, -47, -31], [-32, 47, -31], [33, 46, 32],
                                             [-33, -46, 32], [33, -46, -32], [-33, 46, -32],
                                             [34, 45, 33], [-34, -45, 33], [34, -45, -33],
                                             [-34, 45, -33], [35, 44, 34], [-35, -44, 34],
                                             [35, -44, -34], [-35, 44, -34], [36, 43, 35],
                                             [-36, -43, 35], [36, -43, -35], [-36, 43, -35],
                                             [37, 42, 36], [-37, -42, 36], [37, -42, -36],
                                             [-37, 42, -36], [38, 41, 37], [-38, -41, 37],
                                             [38, -41, -37], [-38, 41, -37], [39, 40, -38],
                                             [-39, -40, -38], [39, -40, 38], [-39, 40, 38]]).solve()

    elapsed_time_pysat = time() - start_time
    start_time = time()
    llamada_a_tu_satsolver = solve_SAT(60, [[39, 40, 1], [-39, -40, 1], [39, -40, -1], [-39, 40, -1],
                                            [1, 41, 2], [-1, -41, 2], [1, -41, -2], [-1, 41, -2],
                                            [2, 42, 3], [-2, -42, 3], [2, -42, -3], [-2, 42, -3],
                                            [3, 43, 4], [-3, -43, 4], [3, -43, -4], [-3, 43, -4],
                                            [4, 44, 5], [-4, -44, 5], [4, -44, -5], [-4, 44, -5],
                                            [5, 45, 6], [-5, -45, 6], [5, -45, -6], [-5, 45, -6],
                                            [6, 46, 7], [-6, -46, 7], [6, -46, -7], [-6, 46, -7],
                                            [7, 47, 8], [-7, -47, 8], [7, -47, -8], [-7, 47, -8],
                                            [8, 48, 9], [-8, -48, 9], [8, -48, -9], [-8, 48, -9],
                                            [9, 49, 10], [-9, -49, 10], [9, -49, -10], [-9, 49, -10],
                                            [10, 50, 11], [-10, -50, 11], [10, -50, -11],
                                            [-10, 50, -11], [11, 51, 12], [-11, -51, 12],
                                            [11, -51, -12], [-11, 51, -12], [12, 52, 13],
                                            [-12, -52, 13], [12, -52, -13], [-12, 52, -13],
                                            [13, 53, 14], [-13, -53, 14], [13, -53, -14],
                                            [-13, 53, -14], [14, 54, 15], [-14, -54, 15],
                                            [14, -54, -15], [-14, 54, -15], [15, 55, 16],
                                            [-15, -55, 16], [15, -55, -16], [-15, 55, -16],
                                            [16, 56, 17], [-16, -56, 17], [16, -56, -17],
                                            [-16, 56, -17], [17, 57, 18], [-17, -57, 18],
                                            [17, -57, -18], [-17, 57, -18], [18, 58, 19],
                                            [-18, -58, 19], [18, -58, -19], [-18, 58, -19],
                                            [19, 59, 60], [-19, -59, 60], [19, -59, -60],
                                            [-19, 59, -60], [20, 59, 60], [-20, -59, 60],
                                            [20, -59, -60], [-20, 59, -60], [21, 58, 20],
                                            [-21, -58, 20], [21, -58, -20], [-21, 58, -20],
                                            [22, 57, 21], [-22, -57, 21], [22, -57, -21],
                                            [-22, 57, -21], [23, 56, 22], [-23, -56, 22],
                                            [23, -56, -22], [-23, 56, -22], [24, 55, 23],
                                            [-24, -55, 23], [24, -55, -23], [-24, 55, -23],
                                            [25, 54, 24], [-25, -54, 24], [25, -54, -24],
                                            [-25, 54, -24], [26, 53, 25], [-26, -53, 25],
                                            [26, -53, -25], [-26, 53, -25], [27, 52, 26],
                                            [-27, -52, 26], [27, -52, -26], [-27, 52, -26],
                                            [28, 51, 27], [-28, -51, 27], [28, -51, -27],
                                            [-28, 51, -27], [29, 50, 28], [-29, -50, 28],
                                            [29, -50, -28], [-29, 50, -28], [30, 49, 29],
                                            [-30, -49, 29], [30, -49, -29], [-30, 49, -29],
                                            [31, 48, 30], [-31, -48, 30], [31, -48, -30],
                                            [-31, 48, -30], [32, 47, 31], [-32, -47, 31],
                                            [32, -47, -31], [-32, 47, -31], [33, 46, 32],
                                            [-33, -46, 32], [33, -46, -32], [-33, 46, -32],
                                            [34, 45, 33], [-34, -45, 33], [34, -45, -33],
                                            [-34, 45, -33], [35, 44, 34], [-35, -44, 34],
                                            [35, -44, -34], [-35, 44, -34], [36, 43, 35],
                                            [-36, -43, 35], [36, -43, -35], [-36, 43, -35],
                                            [37, 42, 36], [-37, -42, 36], [37, -42, -36],
                                            [-37, 42, -36], [38, 41, 37], [-38, -41, 37],
                                            [38, -41, -37], [-38, 41, -37], [39, 40, -38],
                                            [-39, -40, -38], [39, -40, 38], [-39, 40, 38]])

    assert (llamada_a_tu_satsolver == "UNSATISFIABLE")
    assert (llamada_a_pysat == False)
    elapsed_time_SATsolver = time() - start_time
    if llamada_a_tu_satsolver == "UNSATISFIABLE":
        print("Con tu SATsolver esta CNF es insatisfactible")
    else:
        print("Con tu SATsolver esta CNF es satisfactible")
    if llamada_a_pysat:
        print("Con Pysat esta CNF es satisfactible")
    else:
        print("Con Pysat esta CNF es insatisfactible")

    print("\n" + "El tiempo empleado por tu SATsolver es: ")
    print(elapsed_time_SATsolver)
    print("\n" + "El tiempo empleado por Pysat es: ")
    print(elapsed_time_pysat)

# test1()
# test2()
test4()
